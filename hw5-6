from db import main_db
import flet as ft
from datetime import datetime

def main(page: ft.Page):
    page.title = "ToDo List"
    page.theme_mode = ft.ThemeMode.LIGHT
    page.vertical_alignment = ft.MainAxisAlignment.START

    task_list = ft.Column()
    empty_text = ft.Text("Тут ничего нет", visible=False)

    def refresh_tasks():
        tasks = main_db.get_tasks()
        task_list.controls = [create_task_row(id, text, created_at) for id, text, created_at in tasks]
        empty_text.visible = not tasks
        page.update()

    def create_task_row(task_id, text, created_at):
        field = ft.TextField(value=text, read_only=True, expand=True)
        time_label = ft.Text(created_at, color=ft.colors.GREY, size=12)

        def edit(_):
            field.read_only = False
            field.update()

        def save(_):
            main_db.update_task(task_id, field.value)
            field.read_only = True
            field.update()

        def delete(_):
            main_db.delete_task(task_id)
            refresh_tasks()

        return ft.Row(
            [
                ft.Column([field, time_label], expand=True),
                ft.IconButton(icon=ft.Icons.EDIT, on_click=edit),
                ft.IconButton(icon=ft.Icons.SAVE, on_click=save),
                ft.IconButton(icon=ft.Icons.DELETE, on_click=delete, icon_color="red"),
            ]
        )

    def add_task(_):
        if task_input.value.strip():
            task_id = main_db.add_task(task_input.value.strip())
            refresh_tasks()
            task_input.value = ""
            page.update()

    def delete_last(_):
        main_db.delete_last_task()
        refresh_tasks()

    task_input = ft.TextField(label="Введите задачу", expand=True)
    add_btn = ft.ElevatedButton("Добавить", on_click=add_task)
    del_btn = ft.ElevatedButton("Удалить последнее", on_click=delete_last)

    page.add(ft.Row([task_input, add_btn, del_btn]), empty_text, task_list)
    refresh_tasks()

if __name__ == "__main__":
    main_db.init_db()
    ft.app(target=main)
